<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Offline PDF Metadata Editor</title>
</head>
<body>
  <h2>Offline PDF Metadata Editor</h2>

  <p>Select a PDF and load metadata:</p>
  <input id="fileInput" type="file" accept="application/pdf" />
  <button onclick="loadMetadata()">Load Metadata</button>

  <hr/>

  <label>Title:</label><br/>
  <input id="metaTitle" type="text" style="width:300px;"><br/><br/>

  <label>Author:</label><br/>
  <input id="metaAuthor" type="text" style="width:300px;"><br/><br/>

  <label>Subject:</label><br/>
  <input id="metaSubject" type="text" style="width:300px;"><br/><br/>

  <label>Keywords (comma separated):</label><br/>
  <input id="metaKeywords" type="text" style="width:300px;"><br/><br/>

  <button onclick="savePdf()">Save & Download Edited PDF</button>

  <h3>Raw Metadata</h3>
  <pre id="rawInfo">-</pre>

  <!-- Load pdf-lib locally -->
  <script src="./pdf-lib.min.js"></script>

  <script>
    let originalBytes = null;
    let originalFilename = null;

    async function loadMetadata() {
      const { PDFDocument } = window.pdfLib;

      const file = document.getElementById("fileInput").files[0];
      if (!file) {
        alert("Choose a PDF first!");
        return;
      }

      originalFilename = file.name;
      originalBytes = await file.arrayBuffer();
      const pdfDoc = await PDFDocument.load(originalBytes);

      const meta = {
        Title: pdfDoc.getTitle() || "",
        Author: pdfDoc.getAuthor() || "",
        Subject: pdfDoc.getSubject() || "",
        Keywords: pdfDoc.getKeywords() || ""
      };

      document.getElementById("metaTitle").value = meta.Title;
      document.getElementById("metaAuthor").value = meta.Author;
      document.getElementById("metaSubject").value = meta.Subject;
      document.getElementById("metaKeywords").value = Array.isArray(meta.Keywords) ? meta.Keywords.join(", ") : meta.Keywords;

      document.getElementById("rawInfo").textContent = JSON.stringify(meta, null, 2);
    }

    async function savePdf() {
      const { PDFDocument } = window.pdfLib;

      if (!originalBytes) {
        alert("Load a PDF first.");
        return;
      }

      const pdfDoc = await PDFDocument.load(originalBytes);

      pdfDoc.setTitle(document.getElementById("metaTitle").value);
      pdfDoc.setAuthor(document.getElementById("metaAuthor").value);
      pdfDoc.setSubject(document.getElementById("metaSubject").value);
      pdfDoc.setKeywords(document.getElementById("metaKeywords").value);

      const newBytes = await pdfDoc.save();

      const blob = new Blob([new Uint8Array(newBytes)], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = originalFilename.replace(/\.pdf$/i, "") + "-edited.pdf";
      a.click();

      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
